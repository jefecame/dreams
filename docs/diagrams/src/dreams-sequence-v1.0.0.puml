@startuml Dreams Sales Process - Sequence Diagram

!theme blueprint

' Configuration
skinparam backgroundColor transparent
skinparam shadowing false
skinparam sequenceMessageAlign center
skinparam sequenceArrowThickness 2

' Participants styling
skinparam participant {
    BackgroundColor #E8F4FD
    BorderColor #2E86AB
    FontColor #1F4E79
}

skinparam actor {
    BackgroundColor #F24236
    BorderColor #A23B72
    FontColor White
}

title Dreams Sales System - Complete Sale Process\n<size:14><color:gray>Customer Purchase Journey</color></size>

' === PARTICIPANTS ===
actor "👤 Customer" as Customer #LightBlue
participant "🖥️ Sales UI" as UI #LightGreen  
participant "📋 Sales Controller" as Controller #LightYellow
participant "🏪 Sale Service" as SaleService #Orange
participant "📦 Product Service" as ProductService #LightPink
participant "👥 Customer Service" as CustomerService #LightGray
participant "💾 Database" as DB #LightCyan

' === ACTIVATION BOXES ===
activate Customer

' === MAIN FLOW ===

group Customer Selection Phase
    Customer -> UI : 1. Browse products
    activate UI
    
    UI -> Controller : 2. Get available products
    activate Controller
    
    Controller -> ProductService : 3. Find active products
    activate ProductService
    
    ProductService -> DB : 4. Query products WHERE active = true
    activate DB
    DB --> ProductService : 5. Return product list
    deactivate DB
    
    ProductService --> Controller : 6. Available products
    deactivate ProductService
    
    Controller --> UI : 7. Product catalog
    deactivate Controller
    
    UI --> Customer : 8. Display products
    deactivate UI
end

group Cart Management Phase
    Customer -> UI : 9. Add product to cart (productId, quantity)
    activate UI
    
    UI -> Controller : 10. Validate and add item
    activate Controller
    
    Controller -> ProductService : 11. Check availability(productId, quantity)
    activate ProductService
    
    ProductService -> DB : 12. SELECT stock FROM products WHERE id = ?
    activate DB
    DB --> ProductService : 13. Current stock level
    deactivate DB
    
    alt Stock Available
        ProductService --> Controller : 14. ✅ Stock confirmed
        deactivate ProductService
        
        Controller -> SaleService : 15. Create/Update cart
        activate SaleService
        
        SaleService -> DB : 16. INSERT/UPDATE sale_items
        activate DB
        DB --> SaleService : 17. Item added successfully
        deactivate DB
        
        SaleService --> Controller : 18. Cart updated
        deactivate SaleService
        
        Controller --> UI : 19. Success response
        deactivate Controller
        
        UI --> Customer : 20. Item added to cart ✅
        deactivate UI
        
    else Insufficient Stock
        ProductService --> Controller : 14. ❌ Insufficient stock
        deactivate ProductService
        Controller --> UI : 19. Error: Not enough stock
        deactivate Controller
        UI --> Customer : 20. Stock unavailable ❌
        deactivate UI
    end
end

group Customer Information Phase
    Customer -> UI : 21. Proceed to checkout
    activate UI
    
    UI -> Controller : 22. Request customer info
    activate Controller
    
    alt Existing Customer
        Controller -> CustomerService : 23. Lookup customer
        activate CustomerService
        
        CustomerService -> DB : 24. SELECT * FROM customers WHERE email = ?
        activate DB
        DB --> CustomerService : 25. Customer data
        deactivate DB
        
        CustomerService --> Controller : 26. Customer found
        deactivate CustomerService
        
    else New Customer  
        Controller -> CustomerService : 27. Create new customer
        activate CustomerService
        
        CustomerService -> DB : 28. INSERT INTO customers
        activate DB
        DB --> CustomerService : 29. Customer ID
        deactivate DB
        
        CustomerService --> Controller : 30. Customer created
        deactivate CustomerService
    end
    
    Controller --> UI : 31. Customer ready
    deactivate Controller
    UI --> Customer : 32. Checkout form
    deactivate UI
end

group Sale Processing Phase
    Customer -> UI : 33. Complete purchase
    activate UI
    
    UI -> Controller : 34. Process sale
    activate Controller
    
    Controller -> SaleService : 35. Process sale transaction
    activate SaleService
    
    ' Start transaction
    SaleService -> DB : 36. BEGIN TRANSACTION
    activate DB
    
    ' Calculate totals
    SaleService -> SaleService : 37. Calculate totals & taxes
    
    ' Reserve stock
    loop For each sale item
        SaleService -> ProductService : 38. Reserve stock(productId, quantity)
        activate ProductService
        
        ProductService -> DB : 39. UPDATE products SET stock = stock - ? WHERE id = ?
        DB --> ProductService : 40. Stock updated
        deactivate ProductService
    end
    
    ' Create final sale record
    SaleService -> DB : 41. INSERT INTO sales (customer_id, total, status)
    DB --> SaleService : 42. Sale ID created
    
    ' Update sale items with final sale ID
    SaleService -> DB : 43. UPDATE sale_items SET sale_id = ?
    DB --> SaleService : 44. Items linked to sale
    
    ' Commit transaction
    SaleService -> DB : 45. COMMIT TRANSACTION
    DB --> SaleService : 46. ✅ Transaction committed
    deactivate DB
    
    SaleService --> Controller : 47. Sale completed successfully
    deactivate SaleService
    
    Controller --> UI : 48. Sale confirmation
    deactivate Controller
    
    UI --> Customer : 49. 🎉 Purchase successful!\nOrder #12345
    deactivate UI
end

group Post-Sale Phase
    Customer -> UI : 50. Request receipt
    activate UI
    
    UI -> Controller : 51. Generate receipt
    activate Controller
    
    Controller -> SaleService : 52. Create invoice
    activate SaleService
    
    SaleService -> DB : 53. Get sale details with items
    activate DB
    DB --> SaleService : 54. Complete sale data
    deactivate DB
    
    SaleService -> SaleService : 55. Format invoice
    SaleService --> Controller : 56. Invoice PDF/data
    deactivate SaleService
    
    Controller --> UI : 57. Receipt ready
    deactivate Controller
    
    UI --> Customer : 58. 📄 Download receipt
    deactivate UI
end

deactivate Customer

' === NOTES ===
note over Customer, DB
    **Key Features:**
    • Stock validation before adding to cart
    • Transaction safety with rollback capability  
    • Automatic total calculation with taxes
    • Customer creation or lookup
    • Invoice generation
    • Audit trail for all operations
end note

note right of SaleService
    **Business Rules:**
    • Stock must be available
    • Customer info required
    • All operations in transaction
    • Automatic total calculation
    • Status tracking throughout
end note

@enduml
